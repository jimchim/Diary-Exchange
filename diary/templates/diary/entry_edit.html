{% extends 'base.html' %}

{% block css %}
	<style type="text/css">
		.form-control, .btn {
			border-radius: 0;
			margin-top: 1em;
		}

		textarea {
			min-height: 20em;
			max-width: 100%;
			resize: none;
		}

		img {
			width: 100%;
			margin-top: 1em;
		}

		img.half-size {
			width: 50%;
		}




	</style>
{% endblock css %}

{% block content %}	
	{% if entry %}
		<form id = 'edit-entry-form' action = "{% url 'diary:entry_edit' entry.id %}" method = 'post' enctype="multipart/form-data">
			{% csrf_token %}
			<button id = 'delete-entry' class = 'btn btn-danger'>Delete Entry</button>
			<input type = 'submit' value = 'Update Entry' class = 'btn btn-warning pull-right'>
			<input class = 'form-control' type = 'text' name = 'entry-subject' value = '{{ entry.subject }}' autocomplete = 'off'>
			<textarea class = 'form-control' name = 'entry-body'>{{ entry.body }}</textarea>
			<input type = 'hidden' value = 'False' name = 'entry-delete'>

			<input class = 'form-control' type = 'hidden' placeholder = 'Selected Photo' name = 'selected-entry-photo'>

			<input class = 'form-control' type = 'file' name = 'new-entry-photo' id = "multi" multiple>
			<input type = 'hidden' name = "invalid-images">
			{% if entry.entryphoto_set.first != None %}
				{% for picture in entry.entryphoto_set.all %}
					{# <h1>{{ picture.id }}</h1> #}
					<img src="{{picture.image_file.url}}" id = '{{ picture.id }}' >
				{% endfor%}
			{% endif %}
		</form>
		<div id = 'image-previews'></div>	


	{% else %}
		<h1>This is edit entry page</h1>
	{% endif %}

	

{% endblock content %}

{% block script %}
	{% load staticfiles %}
	<script type="text/javascript" src = '{% static "library/autosize/jquery.autosize.min.js" %}'></script>	
	<script type="text/javascript">
		$(document).ready(function(){
			$('#delete-entry').click(function(){
				var delEntry = confirm('Delete this diary entry?')
				if (delEntry) {
					$("input[name='entry-delete']").val('True')										
					$('#edit-entry-form').submit()
					return false
					
				}

				else {
					return false
				}


			})

			$('input[type="submit"]').click(function(e){
				var sub = $('input[name = "entry-subject"]').val()
				var bod = $('textarea[name = "entry-body"]').val()								
				if (sub.length * bod.length == 0) {
					e.preventDefault()					
				}
			})

			$('#edit-entry-form textarea').focus(function(){
				$(this).autosize();
			})

			$('img').click(function(){				
				var selectPhotoIDs = $("input[name='selected-entry-photo']").val()				
				var thisID = $(this).attr('id')
				var IDs = selectPhotoIDs.split(',')				
				if (IDs.indexOf(thisID) == -1) {					
					var photoIDToAdd = thisID + ','
					selectPhotoIDs += photoIDToAdd
					$("input[name='selected-entry-photo']").val(selectPhotoIDs)	
					$(this).addClass('half-size')
				} 

				else {
					/*alert(IDs)
					alert(IDs)*/
					IDs.splice(IDs.indexOf(thisID),1)
					$("input[name='selected-entry-photo']").val(IDs)					
					$(this).removeClass('half-size')
				}
				
				
			})

			var fileList = []

			function verifyImage(image) {
				var reader = new FileReader()
				var img = new Image() // Image object used to test the uploaded image file

				reader.readAsDataURL(image)



				reader.onloadend = function(){
					img.src = reader.result
					img.onload = function(_image){
						var preview = document.getElementById('image-previews')						
						$(preview).append('<img src = "' + reader.result + '">')												
						/*console.log(img.src)
						console.log(image)						*/
					}
					img.onerror = function(){
						console.log(image.name + ' is invalid')
						fileList.push(image.name)
						$('input[name="invalid-images"]').val(fileList)
					}					
				} 

				//console.log(image + ' is valid.')
			} 

			$('#multi').change(function(){

				// prevent user trying to submit multiple images 
				$('input[name="invalid-images"]').val(null) 
				fileList = []


				if (this.files.length < 1) {
					console.log('Empty file input at #multi')
					return
				}
				
				//else

				var files = this.files
				var invalidFiles = []
				var allowedFormat = ['jpg', 'jpeg', 'gif','png','bmp']				

				for (var i = 0; i < files.length ; i++) {										
					var file = this.files[i]
					var name = file.name
					var extension = file.name.split('.').pop().toLowerCase() // ensure match with lowercased allowedFormat
					var sizeInMB = file.size/1024/1024					

					if (sizeInMB > 50) { 
						invalidFiles.push(file) 
						console.log(name + ' is too big, please upload images under 50 MBs.')
					}

					if ( allowedFormat.indexOf(extension) == -1 ) {  // not in allowed formats
						invalidFiles.push(file) 
						console.log(name + ' is not in a supported file format, please upload JPG / GIF / PNG or BMP images only.')
					}

					try {
						verifyImage(file)
					}

					catch (error) {
						console.log('foo.jpg?')
					}					
					
				} // end for				
				return 
			})			
		})		
	</script>

{% endblock script %}